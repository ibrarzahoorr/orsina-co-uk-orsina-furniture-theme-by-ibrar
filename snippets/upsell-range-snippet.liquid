{% comment %}
  Snippet: Upsell Range Carousel
  Purpose: Show products referenced in product metafield `custom.range` (List of Products)
  Use: Include this snippet inside product pages (like product description area OR sidebar upsell widgets).
  Notes:
    - Create product metafield definition: Namespace `custom`, Key `range`, Type "List of products".
    - Works with single or list product references.
{% endcomment %}

{% liquid
  assign m = product.metafields.custom.range
  assign products = nil
  if m and m.value != blank
    if m.type contains 'list' and m.type contains 'product_reference'
      assign products = m.value
    elsif m.type contains 'product_reference'
      assign single = m.value
      assign products = single | array
    endif
  endif
%}

{% if products and products.size > 0 %}
  <div class="upsell-snippet" id="upsell-range-{{ product.id }}">
    <div class="upsell-header">
      <h3>{{ heading | default: 'You may also like' }}</h3>
    </div>

    <div class="upsell-carousel">
      <button class="arrow left" aria-label="Scroll left">&#10094;</button>
      <div class="track">
        {% for p in products %}
          {% assign featured = p.featured_media | default: p.featured_image %}
          {% assign first_variant = p.variants.first %}
          <div class="card">
            <a href="{{ p.url }}" class="thumb">
              {% if featured %}
                <img
                  src="{{ featured | image_url: width: 400 }}"
                  alt="{{ featured.alt | escape }}"
                  loading="lazy">
              {% endif %}
            </a>
            <div class="info">
              <a href="{{ p.url }}" class="title">{{ p.title }}</a>
              <div class="price">
                {% assign price = p.price %}
                {% assign compare = p.compare_at_price %}
                {% if compare > price %}
                  <span class="current">{{ price | money }}</span>
                  <s class="compare">{{ compare | money }}</s>
                {% else %}
                  <span class="current">{{ price | money }}</span>
                {% endif %}
              </div>
              {% if enable_quick_add %}
                {% if p.available %}
                  {% if p.has_only_default_variant and first_variant.available %}
                    <button class="btn add-to-cart" data-variant-id="{{ first_variant.id }}">Add to cart</button>
                  {% else %}
                    <a class="btn outline" href="{{ p.url }}">Choose options</a>
                  {% endif %}
                {% else %}
                  <button class="btn disabled" disabled>Sold out</button>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      <button class="arrow right" aria-label="Scroll right">&#10095;</button>
    </div>
  </div>
{% endif %}

<style>
  .upsell-snippet { margin: 20px 0; }
  .upsell-carousel { position:relative; }
  .upsell-carousel .track { display:flex; gap:16px; overflow-x:auto; scroll-snap-type: x mandatory; padding: 8px; }
  .card { flex:0 0 auto; min-width:200px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); scroll-snap-align:start; }
  .thumb img { width:100%; border-radius:12px 12px 0 0; object-fit:cover; }
  .info { padding:10px; }
  .title { font-size:.9rem; text-decoration:none; color:#222; }
  .price { font-weight:600; margin-top:6px; }
  .price .compare { opacity:.6; margin-left:6px; }
  .btn { display:block; width:100%; padding:8px; margin-top:8px; border-radius:999px; text-align:center; border:none; cursor:pointer; background:#111; color:#fff; font-size:.85rem; }
  .btn.outline { background:transparent; border:1px solid #111; color:#111; }
  .btn.disabled { opacity:.5; cursor:not-allowed; }
  .upsell-carousel .arrow { position:absolute; top:50%; transform:translateY(-50%); background:#eee; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; }
  .arrow.left { left:0; }
  .arrow.right { right:0; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.upsell-snippet').forEach(root => {
      const scroller = root.querySelector('.track');
      const left = root.querySelector('.arrow.left');
      const right = root.querySelector('.arrow.right');
      function scrollByCard(dir){
        const card = scroller.querySelector('.card');
        const amount = card ? card.getBoundingClientRect().width + 16 : 200;
        scroller.scrollBy({ left: dir*amount, behavior:'smooth' });
      }
      left?.addEventListener('click',()=>scrollByCard(-1));
      right?.addEventListener('click',()=>scrollByCard(1));

      root.addEventListener('click', async e => {
        const btn = e.target.closest('.add-to-cart');
        if (!btn) return;
        const id = btn.dataset.variantId;
        btn.disabled = true;
        try {
          await fetch('/cart/add.js', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ items:[{id:Number(id),quantity:1}] })
          });
          btn.textContent = 'Added!';
          document.dispatchEvent(new CustomEvent('cart:refresh'));
        } catch(e){
          btn.textContent = 'Error';
        } finally {
          setTimeout(()=>{ btn.disabled=false; btn.textContent='Add to cart'; },1500);
        }
      });
    });
  });
</script>

<!-- ========================= -->
<!-- SNIPPET VERSION (render anywhere) -->
<!-- File: snippets/upsell-range-snippet.liquid -->

{% comment %}
  Snippet: Upsell Range Carousel (metafield-driven)
  Use this when you don't want a full Section. Can be rendered on product page,
  sidebar, article, cart drawer, etc.

  Usage examples:
  1) On product page (uses product.metafields.custom.range by default):
     {% render 'upsell-range-snippet', product: product, heading: 'You may also like' %}

  2) Anywhere else (pass a product explicitly):
     {% assign p = all_products['handle-of-your-product'] %}
     {% render 'upsell-range-snippet', product: p, heading: 'Complete the look' %}

  3) Override with a custom products array (ignores metafield):
     {% assign a = all_products['a-handle'] %}
     {% assign b = all_products['b-handle'] %}
     {% render 'upsell-range-snippet', products: a | array | push: b, heading: 'Recommended' %}

  Params (all optional):
    - product: the source product for metafield lookup
    - products: array of product objects to render (overrides metafield)
    - heading: text heading
    - show_vendor: boolean (default false)
    - enable_quick_add: boolean (default true)
    - max_items: number (default 12)
    - card_min_width: number (px, default 220)
    - image_ratio: '1/1' | '4/5' | '3/2' (default '1/1')
    - view_all_link, view_all_label
{% endcomment %}

{% liquid
  assign src_product = src_product | default: product | default: nil
  assign heading = heading | default: 'You may also like'
  assign show_vendor = show_vendor | default: false
  assign enable_quick_add = enable_quick_add | default: true
  assign max_items = max_items | default: 12
  assign card_min_width = card_min_width | default: 220
  assign image_ratio = image_ratio | default: '1/1'

  assign list = nil
  if products
    assign list = products
  elsif src_product and src_product.metafields.custom and src_product.metafields.custom.range
    assign m = src_product.metafields.custom.range
    if m and m.value != blank
      if m.type contains 'list' and m.type contains 'product_reference'
        assign list = m.value
      elsif m.type contains 'product_reference'
        assign single = m.value
        assign list = single | array
      endif
    endif
  endif
%}

{% if list and list.size > 0 %}
<div class="upsell-range-snippet" style="--card-min: {{ card_min_width }}px">
  <div class="upsell-hd">
    <h3 class="upsell-ttl">{{ heading | escape }}</h3>
    {% if view_all_link %}<a class="upsell-viewall" href="{{ view_all_link }}">{{ view_all_label | default: 'View all' }}</a>{% endif %}
  </div>

  <div class="upsell-wrap">
    <button class="upsell-arr is-left" type="button" aria-label="Scroll left">&#10094;</button>
    <div class="upsell-track" role="list">
      {% for p in list limit: max_items %}
        {% liquid
          assign media = p.featured_media
          if media == nil
            assign media = p.media | where: 'media_type', 'image' | first
          endif
        %}
        <article class="upsell-card" role="listitem">
          <a href="{{ p.url }}" class="upsell-thumb" aria-label="View {{ p.title | escape }}">
            <div class="upsell-media" style="--ratio: {{ image_ratio }}">
              {% if media and media.preview_image %}
                <img
                  src="{{ media | image_url: width: 560 }}"
                  srcset="{{ media | image_url: width: 320 }} 320w, {{ media | image_url: width: 480 }} 480w, {{ media | image_url: width: 640 }} 640w, {{ media | image_url: width: 800 }} 800w"
                  sizes="(max-width: 768px) 70vw, 280px"
                  alt="{{ media.alt | default: p.title | escape }}"
                  loading="lazy">
              {% elsif p.featured_image %}
                <img
                  src="{{ p.featured_image | image_url: width: 560 }}"
                  srcset="{{ p.featured_image | image_url: width: 320 }} 320w, {{ p.featured_image | image_url: width: 480 }} 480w, {{ p.featured_image | image_url: width: 640 }} 640w, {{ p.featured_image | image_url: width: 800 }} 800w"
                  sizes="(max-width: 768px) 70vw, 280px"
                  alt="{{ p.title | escape }}"
                  loading="lazy">
              {% else %}
                <div class="upsell-ph" aria-hidden="true"></div>
              {% endif %}
            </div>
          </a>

          <div class="upsell-info">
            {% if show_vendor and p.vendor %}
              <div class="upsell-vendor">{{ p.vendor }}</div>
            {% endif %}
            <a href="{{ p.url }}" class="upsell-title">{{ p.title }}</a>
            <div class="upsell-price">
              {% assign price = p.price %}
              {% assign compare = p.compare_at_price %}
              {% if compare > price %}
                <span class="now">{{ price | money }}</span>
                <s class="was">{{ compare | money }}</s>
                <span class="badge">Sale</span>
              {% else %}
                <span class="now">{{ price | money }}</span>
              {% endif %}
            </div>
            {% if enable_quick_add %}
              <div class="upsell-actions">
                {% assign first_variant = p.variants.first %}
                {% if p.available %}
                  {% if p.has_only_default_variant and first_variant.available %}
                    <button class="upsell-btn js-ua" type="button" data-variant-id="{{ first_variant.id }}">Add to cart</button>
                  {% else %}
                    <a class="upsell-btn is-outline" href="{{ p.url }}">Choose options</a>
                  {% endif %}
                {% else %}
                  <button class="upsell-btn" disabled>Sold out</button>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
    <button class="upsell-arr is-right" type="button" aria-label="Scroll right">&#10095;</button>
    <div class="upsell-fade is-left" aria-hidden="true"></div>
    <div class="upsell-fade is-right" aria-hidden="true"></div>
  </div>
</div>

<style>
  .upsell-range-snippet { margin: 18px 0; }
  .upsell-hd { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 8px; }
  .upsell-ttl { margin:0; font-size: clamp(1rem, 1vw + .7rem, 1.3rem); }
  .upsell-viewall { text-decoration:none; font-size:.92rem; }
  .upsell-wrap { position: relative; }
  .upsell-track { display:grid; grid-auto-flow:column; grid-auto-columns:minmax(var(--card-min,220px),1fr); gap:14px; overflow-x:auto; scroll-snap-type:x mandatory; scroll-padding:10px; padding:6px 10px 12px; -webkit-overflow-scrolling:touch; }
  .upsell-track::-webkit-scrollbar{ height:10px;} .upsell-track::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.2); border-radius:10px;}
  .upsell-card{ background: color-mix(in oklab, canvas, black 3%); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.06); overflow:hidden; scroll-snap-align:start; display:flex; flex-direction:column; }
  .upsell-media{ width:100%; aspect-ratio: var(--ratio, 1/1); background: color-mix(in oklab, canvas, black 6%);} .upsell-media img{ width:100%; height:100%; object-fit:cover; display:block; }
  .upsell-ph{ width:100%; height:100%; background: repeating-linear-gradient(45deg, #eee, #eee 10px, #f8f8f8 10px, #f8f8f8 20px);} 
  .upsell-info{ padding:10px; display:flex; flex-direction:column; gap:6px; }
  .upsell-vendor{ font-size:.78rem; opacity:.7; }
  .upsell-title{ text-decoration:none; color:inherit; font-size:.94rem; line-height:1.35; }
  .upsell-price{ display:flex; align-items:center; gap:8px; font-weight:600; } .upsell-price .was{ opacity:.6; } .badge{ font-size:.72rem; background:#ffebec; color:#d1273b; padding:2px 6px; border-radius:999px; }
  .upsell-actions{ margin-top:4px; }
  .upsell-btn{ width:100%; border:none; border-radius:999px; padding:9px 11px; font-weight:600; cursor:pointer; background: color-mix(in oklab, canvasText, canvas 85%); color: canvas; } 
  .upsell-btn.is-outline{ background:transparent; color:inherit; border:1px solid color-mix(in oklab, canvasText, canvas 75%);} 
  .upsell-arr{ position:absolute; top:50%; transform:translateY(-50%); z-index:2; width:36px; height:36px; border:none; border-radius:50%; display:grid; place-items:center; cursor:pointer; background: color-mix(in oklab, canvas, canvasText 8%); backdrop-filter: blur(4px);} 
  .upsell-arr.is-left{ left:6px;} .upsell-arr.is-right{ right:6px; }
  .upsell-fade{ position:absolute; top:0; bottom:0; width:48px; pointer-events:none;} .upsell-fade.is-left{ left:0; background: linear-gradient(90deg, color-mix(in oklab, canvas, canvasText 6%), transparent);} .upsell-fade.is-right{ right:0; background: linear-gradient(270deg, color-mix(in oklab, canvas, canvasText 6%), transparent);} 
  @media (prefers-color-scheme: dark){ .badge{ background:#3b0a13; color:#ff96a3; } }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.upsell-range-snippet').forEach(root => {
      const track = root.querySelector('.upsell-track');
      const left = root.querySelector('.upsell-arr.is-left');
      const right = root.querySelector('.upsell-arr.is-right');

      const scrollByCard = (dir=1)=>{
        const card = track.querySelector('.upsell-card');
        const gap = parseInt(getComputedStyle(track).gap||14);
        const w = card ? card.getBoundingClientRect().width + gap : track.clientWidth*0.9;
        track.scrollBy({ left: dir*w*2.1, behavior: 'smooth' });
      };

      left?.addEventListener('click', ()=>scrollByCard(-1));
      right?.addEventListener('click', ()=>scrollByCard(1));

      // Quick Add (single-variant)
      root.addEventListener('click', async (e) => {
        const btn = e.target.closest('.js-ua');
        if (!btn) return;
        const id = btn.getAttribute('data-variant-id');
        if (!id) return;
        btn.disabled = true;
        try {
          const res = await fetch('/cart/add.js', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items:[{ id: Number(id), quantity:1 }] }) });
          if (!res.ok) throw new Error('Add to cart failed');
          btn.textContent = 'Added!';
          document.dispatchEvent(new CustomEvent('cart:refresh'));
        } catch(err){
          console.error(err); btn.textContent = 'Error';
        } finally {
          setTimeout(()=>{ btn.disabled=false; btn.textContent='Add to cart'; }, 1400);
        }
      });
    });
  });
</script>
{% else %}
  {% comment %} Nothing to render â€” no metafield products and no explicit array. {% endcomment %}
{% endif %}

